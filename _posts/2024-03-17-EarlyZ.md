---
layout: post
title: "Early Z and Pre-Pass Z"
categories: graphics
---

<!-- begin_excerpt -->

OpenGL이나 DirectX는 대표적인 Per-Sample Operation인 Depth/Stencil Test 대해 Pixel Shader 이후에 처리하도록 명시하고 있다.

<!-- end_excerpt -->

이는 조금 생각해 보면 당연한 부분으로 Pixel Shader에서 Depth value를 수정하거나 버릴 수 있기 때문에 그렇다. 

만약 Pixel Shader전에 Depth Test한다면 어떻게 될까?

예를들어, Pixel Shader전에 Depth Test를 통과하고 Depth value를 갱신했는데 Pixel Shader에서 어떤 조건에 의해 discard로 픽셀을 폐기한다면 문제가 된다. 

> <font size="2"> 
> 1. GPU는 이미 쓴 값을 되돌리지 않는다. <br>
> 2. Depth Operation은 Test와 Write가 한쌍이라서 Test가 되면 Write도 된다.
> </font>

한편, GPU는 Vertex Shader 출력 값으로 래스터화 처리시 픽셀의 깊이 값을 이미 알고 있다. GPU 재조사는 이 점을 활용하여 프로그래머가 Pixel Shader에서 깊이 값을 변경하지 않는다면 Pixel Shader 이전에 Depth Test를 수행하여 Test에 실패한 픽셀에 대해 Pixel Shader를 처리 않는 최적화를 자동으로 진행한다. 

> <font size="2"> 
>  최적화는 GPU 재조사를 통해 이루어지며, 대부분의 최신 그래픽 카드가 이 기능을 지원한다.
> </font>

다만, 앞서 이야기한 것처럼 Pixel Shader 이전에 Depth Test는 문제가 있을 수 있어 Pixel Shader에서 discard를 사용하거나 gl_FragDepth로 깊이 값을 변경한다면 GPU 재조사는 early z 기능을 자동으로 끈다.

# Pre-Pass Z

Pre-Pass Z는 불투명한 오브젝트만 Depth Buffer에 사전에 기록하는 기능으로, Null Pixel Shader를 할당하고 Vertex Shader에서 Position 계산만 수행하여 빠르게 처리한다.

Pre-Pass Z를 Early Z와 함께 사용하면 불투명 오브젝트를 그릴 때 Pre-Pass Z가 쓴 depth buffer의 값과 같은 깊이 값을 가지는 화면에 보여지게 될 최종 픽셀에 대해서만 Pixel Shader를 수행하고 나머지는 전부 버릴 수 있어 Early Z 기능을 극대화 할 수 있다.


